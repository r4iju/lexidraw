<!-- 4b63b606-bc66-4b49-af61-97900b348610 17cc47dc-68bf-46c2-934b-654635e435f7 -->
# Shared tool contract, server-built tool definitions

## Goal

Have the server build correct model tool definitions using a shared tool contract, while the client continues to execute tools. Avoid empty args and drift between client/server.

## Steps

1) Add shared tool contract

- New file: `packages/types/src/agent-tools-contract.ts`.
- Export small Zod-only contracts: `{ name, description, schema }` for core tools used today:
- sendReply, requestClarificationOrPlan, summarizeExecution
- insertSlideDeckNode
- addSlidePage, removeSlidePage, reorderSlidePage, setSlidePageBackground
- addImageToSlidePage, addChartToSlidePage
- Include minimal shared Zod shapes (e.g., `EditorKeySchema`, `InsertionRelationSchema`, `InsertionAnchorSchema`) locally in the package to avoid React/editor deps.

2) Server builds toolMap from the contract

- In `apps/lexidraw/src/app/api/llm/agent/route.ts`:
- Import the contract map.
- For each requested tool, prefer the contract: convert Zod → JSON Schema with `$refStrategy: "none"` and enforce root `type: "object"`.
- If a tool isn’t in the contract, fall back to `toolDefs` from the client; otherwise use a generic permissive schema (dev log warning).
- Keep existing audit + structured logs.

3) Client uses the same schemas (incremental)

- In `RuntimeToolsProvider` and tool hooks for the same set of core tools, import the input schemas from the contract instead of duplicating them.
- No execution on server; runtime `execute` stays on client.

4) Optimize toolDefs

- In `use-send-query.ts`, when building `toolDefs`, omit tools covered by the contract (server already knows schemas). Keep sending `toolDefs` only for non‑contracted/dynamic tools.

5) Validate and test

- Hello → sendReply (replyText present)
- 2‑slide deck flow (insertSlideDeckNode then addSlidePage args present)
- Edit flows (setSlidePageBackground, addImageToSlidePage)
- Verify server logs show `toolDefNames` empty for contracted tools and `toolCallsCount ≥ 1` with valid inputs.

### To-dos

- [ ] Create shared Zod schema registry for all tools (no client deps)
- [ ] Use registry schemas in /api/llm/agent toolMap
- [ ] Import input schemas from registry in tool hooks
- [ ] Execute returned tool calls client-side; surface terminal outputs
- [ ] Append TOOL_RESULT context and do one follow-up model call
- [ ] Test hello→sendReply; insertTextNode; plan/clarify; summarizeExecution