<!-- ff240700-c551-4ec3-97a8-f1589da9e2f6 77a84bc8-86f1-4181-b9d9-0ba1fe62453e -->
# URL Distillation, Screenshots, and 403 Hardening

## Plan 1: Save entity screenshots while distilling (URLs only)

- **Flow**: When user inputs a URL and clicks Get (Distill), we parse OpenGraph/lead image(s) from the distilled HTML and persist as thumbnails via existing snapshot router.
- **Server changes**
- Edit `apps/lexidraw/src/server/extractors/article.ts` to also return a bestImageUrl field chosen by priority: `og:image` → first `<img>` in sanitized content → site favicon (as fallback).
- Update `apps/lexidraw/src/server/api/routers/entities.ts` `distillUrl`:
- After `extractAndSanitizeArticle`, if `bestImageUrl` is set, download it server-side and upload to Blob.
- Save resulting public URL(s) into `Entities.screenShotLight` and `Entities.screenShotDark` (same image for both).
- Merge distilled payload into `elements` like today.
- Reuse helpers from `snapshotRouter` where sensible; if helper reuse requires import cycles, inline minimal upload helper using `@vercel/blob` like in `snapshot.ts`.
- **Client changes**
- No changes to dashboard rendering: `apps/lexidraw/src/app/dashboard/thumbnail-client.tsx` already displays `screenShot*`.

## Plan 1b: Add article URL UX and programmatic title

- **Add URL modal behavior**
- File: `apps/lexidraw/src/app/urls/[urlId]/edit-url-modal.tsx`
- Replace Title input with non-editable text or hide it; store internally only. Visible fields: URL and action buttons.
- Button copy: Primary “Save” keeps URL only; Secondary “Get” triggers distillation immediately.
- On Distill success, if `entity.title` is untouched (still default like “New link”) and the distilled payload has a title, issue a server-side update to set `Entities.title` to distilled title. Keep manual rename via dropdown intact (`.../_actions/rename-inline.tsx`).
- **Server-side title update**
- In `distillUrl`, if current `Entities.title` equals default placeholder or empty, update to distilled.title.

## Plan 2: Automatic thumbnail capturing (URLs only)

- **When**: On successful distillation for URL entities.
- **How**: Use Plan 1’s `bestImageUrl` to set both `screenShotLight`/`screenShotDark`. No client work for drawings/documents.
- **Fallback**: If no good image, leave as existing blank; dashboard will show fallback UI.

## Plan 3: Reduce 403s on distillation

- **Networking**
- User-Agent: Keep modest custom UA, but add a secondary attempt with a standard browser UA if 403 received.
- Accept-Language: Add a common header like `en-US,en;q=0.9`.
- Timeouts: Keep current 15s. Consider 1 retry with exponential backoff on network errors/429/5xx.
- **Domain hygiene**
- Respect robots.txt? Optional read-only fetch; if disallowed, surface a clear error.
- Private/localhost already blocked; keep.
- **HTML retrieval strategies**
- If 403 on main URL, try fetching `text/html` only with reduced headers (no images) and no cookies.
- If still 403 and the page has AMP or mobile alternate via `<link rel="amphtml">`/`<link rel="alternate" media>`, try those once.
- **Cookie support (optional, user-config)**
- If user added per-domain cookies in `Users.config.cookies`, attach for that host to reduce paywall/walled garden 403s.
- **Logging/Telemetry**
- Add reason codes in thrown errors to help triage (e.g., `FETCH_403_PRIMARY`, `FETCH_403_SECONDARY`, `AMP_FALLBACK_MISS`).

## Files to touch

- `apps/lexidraw/src/server/extractors/article.ts`
- `apps/lexidraw/src/server/api/routers/entities.ts`
- `apps/lexidraw/src/app/urls/[urlId]/edit-url-modal.tsx`

## Notes

- We won’t change `globals.css` or Tailwind config.
- We keep thumbnails client untouched; only URLs gain automatic thumbnails.
- We keep rename flow via inline dropdown unchanged.

### To-dos

- [ ] Return bestImageUrl from article extractor
- [ ] On distillUrl, upload bestImageUrl to Blob and set screenShot*
- [ ] If title is default, set to distilled title in distillUrl
- [ ] Hide Title field in add-URL modal; rename Distill to Get
- [ ] Add retry + alt UA + headers; AMP/mobile fallback for 403
- [ ] Attach user-config cookies for domain when present
- [ ] Add structured error codes/telemetry for distillation failures